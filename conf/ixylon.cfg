-- vim:ft=lua
-- Startup script for the interactive mode of ned

local L4 = require("L4");
local ld = L4.default_loader;

local vbus_eth = ld:new_channel();

function ixy_fwd()
    ld:startv({}, "rom/ixy-fwd");
end

function ixy_pcap()
    ld:startv(
        {
            caps = 
                {
                    vbus = vbus_eth,
                },
        },
        "rom/ixy-pcap",
        "0");
end

function ixy_pcap2()
    ld:startv(
        {
            caps =
                {
                    vbus = vbus_eth,
                },
        },
        "rom/ixy-pcap",
        "2");
end

function ixy_pktgen()
    ld:startv(
        {
            caps =
                {
                    vbus = vbus_eth,
                },
        },
        "rom/ixy-pktgen",
        "0");
end

--
-- Start L4Re's IO service
--
ld:start(
    {
        caps = {
            sigma0  = L4.cast(L4.Proto.Factory, L4.Env.sigma0):create(L4.Proto.Sigma0);
            icu     = L4.Env.icu;
            iommu   = L4.Env.iommu;
            ethdevs = vbus_eth:svr();
        },
        log = { "io", "r" },
    },
    "rom/io rom/ixylon.vbus -v"
);

--
-- Start interactive ned console
--
cmd = ld:new_channel();

ld:start({ log = L4.Env.log, caps = { svr = cmd }}, "rom/ned-prompt");

L4.server_loop(cmd);
